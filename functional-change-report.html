<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Functional Change Report</title>
  <style>
    :root {
      --color-bg: #ffffff;
      --color-text: #333333;
      --color-primary: #0366d6;
      --color-secondary: #6c757d;
      --color-success: #28a745;
      --color-danger: #dc3545;
      --color-warning: #ffc107;
      --color-info: #17a2b8;
      --color-light: #f8f9fa;
      --color-dark: #343a40;
      --color-p0: #dc3545;
      --color-p1: #ffc107;
      --color-p2: #28a745;
      --color-border: #e1e4e8;
      --color-hover: #f6f8fa;
      --color-code-bg: #f6f8fa;
      --font-mono: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
      --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }
    
    [data-theme="dark"] {
      --color-bg: #0d1117;
      --color-text: #c9d1d9;
      --color-primary: #58a6ff;
      --color-secondary: #8b949e;
      --color-success: #3fb950;
      --color-danger: #f85149;
      --color-warning: #d29922;
      --color-info: #58a6ff;
      --color-light: #161b22;
      --color-dark: #c9d1d9;
      --color-p0: #f85149;
      --color-p1: #d29922;
      --color-p2: #3fb950;
      --color-border: #30363d;
      --color-hover: #161b22;
      --color-code-bg: #161b22;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      color: var(--color-text);
      background-color: var(--color-bg);
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    /* Layout */
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--color-border);
      padding-bottom: 10px;
    }
    
    .controls {
      position: sticky;
      top: 0;
      background-color: var(--color-bg);
      z-index: 100;
      padding: 10px 0;
      border-bottom: 1px solid var(--color-border);
      margin-bottom: 20px;
    }
    
    .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    /* Typography */
    h1 {
      font-size: 24px;
      margin-top: 0;
    }
    
    h2 {
      font-size: 20px;
      margin-top: 30px;
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--color-border);
    }
    
    h3 {
      font-size: 16px;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    
    h4 {
      font-size: 14px;
      margin-top: 15px;
      margin-bottom: 10px;
    }
    
    a {
      color: var(--color-primary);
      text-decoration: none;
    }


    a {
      color: var(--color-primary);
      text-decoration: none;
    }
    
    a:hover {
      text-decoration: underline;
    }
    
    code {
      font-family: var(--font-mono);
      font-size: 85%;
      padding: 0.2em 0.4em;
      background-color: var(--color-code-bg);
      border-radius: 3px;
    }
    
    pre {
      font-family: var(--font-mono);
      font-size: 85%;
      line-height: 1.45;
      background-color: var(--color-code-bg);
      border-radius: 3px;
      overflow: auto;
      padding: 16px;
      margin: 0 0 16px 0;
    }
    
    pre code {
      background-color: transparent;
      padding: 0;
    }
    
    /* Tables */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 16px;
    }
    
    table th, table td {
      padding: 8px 12px;
      border: 1px solid var(--color-border);
      text-align: left;
    }
    
    table th {
      background-color: var(--color-code-bg);
      font-weight: 600;
    }
    
    table tr:nth-child(even) {
      background-color: var(--color-hover);
    }
    
    /* Details/Summary Styles */
    details {
      margin-bottom: 16px;
    }
    
    details > summary {
      cursor: pointer;
      padding: 8px;
      background-color: var(--color-code-bg);
      border-radius: 3px;
      border: 1px solid var(--color-border);
      font-weight: 600;
    }
    
    details[open] > summary {
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
      border-bottom: none;
      margin-bottom: 0;
    }
    
    details > div {
      border: 1px solid var(--color-border);
      border-top: none;
      padding: 8px 16px;
      border-bottom-left-radius: 3px;
      border-bottom-right-radius: 3px;
    }
    
    /* Badge Styles */
    .badge {
      display: inline-block;
      padding: 3px 6px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1;
      margin-left: 5px;
    }
    
    .badge-p0 {
      background-color: var(--color-p0);
      color: white;
    }
    
    .badge-p1 {
      background-color: var(--color-p1);
      color: black;
    }
    
    .badge-p2 {
      background-color: var(--color-p2);
      color: white;
    }
    
    /* Change Type Indicators */
    .change-added {
      background-color: rgba(40, 167, 69, 0.2);
    }
    
    .change-removed {
      background-color: rgba(220, 53, 69, 0.2);
    }
    
    .change-modified {
      background-color: rgba(255, 193, 7, 0.2);
    }
    
    /* Progress Bars */
    .progress-container {
      height: 20px;
      background-color: var(--color-code-bg);
      border-radius: 3px;
      margin-bottom: 16px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      float: left;
      text-align: center;
      color: white;
      font-weight: bold;
      transition: width 0.3s ease;
    }
    
    /* Buttons */
    button, .btn {
      display: inline-block;
      font-weight: 400;
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
      padding: 6px 12px;
      font-size: 14px;
      line-height: 1.5;
      border-radius: 3px;
      color: var(--color-text);
      background-color: var(--color-light);
      border: 1px solid var(--color-border);
      transition: all 0.2s ease-in-out;
    }
    
    button:hover, .btn:hover {
      background-color: var(--color-hover);
    }
    
    button:active, .btn:active {
      transform: translateY(1px);
    }
    
    button:focus, .btn:focus {
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(3, 102, 214, 0.25);
    }
    
    .btn-sm {
      padding: 4px 8px;
      font-size: 12px;
    }
    
    .btn-primary {
      color: white;
      background-color: var(--color-primary);
      border-color: var(--color-primary);
    }
    
    /* Checkbox filters */
    .filter-checkbox {
      display: none;
    }
    
    .filter-label {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 3px;
      border: 1px solid var(--color-border);
      cursor: pointer;
      margin-right: 5px;
      user-select: none;
    }
    
    .filter-checkbox:checked + .filter-label {
      background-color: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    
    /* Theme Switch */
    .theme-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .theme-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--color-secondary);
      transition: .4s;
      border-radius: 24px;
    }
    
    .theme-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .theme-slider {
      background-color: var(--color-primary);
    }
    
    input:checked + .theme-slider:before {
      transform: translateX(26px);
    }
    
    /* Back to top button */
    .back-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background-color: var(--color-primary);
      color: white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s;
      box-shadow: var(--shadow);
    }
    
    .back-to-top.visible {
      opacity: 1;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stats-card {
      border: 1px solid var(--color-border);
      border-radius: 3px;
      padding: 15px;
      box-shadow: var(--shadow);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .filter-group {
        flex-direction: column;
      }
    }
    
    /* Print Styles */
    @media print {
      .controls, .back-to-top {
        display: none !important;
      }
      
      body {
        padding: 0;
      }
      
      .container {
        max-width: none;
      }
      
      details {
        break-inside: avoid;
      }
      
      details[open] > summary {
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìã Advanced Functional Change Report</h1>
      <div>
        <span>Theme:</span>
        <label class="theme-switch">
          <input type="checkbox" id="theme-toggle">
          <span class="theme-slider"></span>
        </label>
      </div>
    </div>
    
    <div class="controls" id="controls">
      <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="Search for changes..." autocomplete="off">
        <div id="search-results" class="search-results"></div>
      </div>
      
      <div class="filter-group">
        <strong>Priority:</strong>
        <input type="checkbox" id="filter-p0" class="filter-checkbox" checked>
        <label for="filter-p0" class="filter-label badge-p0">Critical</label>
        
        <input type="checkbox" id="filter-p1" class="filter-checkbox" checked>
        <label for="filter-p1" class="filter-label badge-p1">Major</label>
        
        <input type="checkbox" id="filter-p2" class="filter-checkbox" checked>
        <label for="filter-p2" class="filter-label badge-p2">Minor</label>
      </div>
      
      <div class="filter-group">
        <strong>Type:</strong>
        <input type="checkbox" id="filter-added" class="filter-checkbox" checked>
        <label for="filter-added" class="filter-label">Added</label>
        
        <input type="checkbox" id="filter-removed" class="filter-checkbox" checked>
        <label for="filter-removed" class="filter-label">Removed</label>
        
        <input type="checkbox" id="filter-modified" class="filter-checkbox" checked>
        <label for="filter-modified" class="filter-label">Modified</label>
      </div>
      
      <div class="filter-group">
        <strong>Category:</strong>
        <div id="category-filters">
          <!-- Dynamically generated based on available categories -->
        </div>
      </div>
      
      <div class="export-group">
        <button id="btn-export-pdf" class="btn btn-sm">üìÑ Export PDF</button>
        <button id="btn-export-html" class="btn btn-sm">üíæ Export HTML</button>
        <button id="btn-export-md" class="btn btn-sm">üìù Export Markdown</button>
        <button id="btn-export-json" class="btn btn-sm">{ } Export JSON</button>
        <button id="btn-reset-filters" class="btn btn-sm btn-primary">üîÑ Reset Filters</button>
      </div>
    </div>
    
    <div id="stats-summary">
      <!-- Statistics summary will be generated here -->
    </div>
    
    <div id="table-of-contents">
      <!-- Table of contents will be generated here -->
    </div>
    
    <div id="executive-summary">
      <!-- Executive summary will be generated here -->
    </div>
    
    <div id="report-content">
      <!-- Report content will be generated here -->
    </div>
  </div>
  
  <div class="back-to-top" id="back-to-top">‚Üë</div>
  
  <script src="../templates/scripts/filters.js"></script>
  <script src="../templates/scripts/visualizations.js"></script>
  <script src="../templates/scripts/interactivity.js"></script>
  <script>
    // Collect all categories
  for (const { changes } of reportData) {
    for (const change of changes) {
      if (change.category) {
        categories[change.category] = true;
        // Initialize filter state
        filterState.category[change.category] = true;
      }
    }
  }
  
  // Create filter checkboxes
  for (const category of Object.keys(categories).sort()) {
    const id = `filter-${category}`;
    
    const input = document.createElement('input');
    input.type = 'checkbox';
    input.id = id;
    input.className = 'filter-checkbox';
    input.checked = true;
    input.dataset.category = category;
    
    const label = document.createElement('label');
    label.htmlFor = id;
    label.className = 'filter-label';
    label.textContent = category.charAt(0).toUpperCase() + category.slice(1);
    
    categoryFilters.appendChild(input);
    categoryFilters.appendChild(label);
  }
}

// Generate report content
function generateReportContent() {
  const reportElement = document.getElementById('report-content');
  let reportHTML = '';
  
  // Generate connector sections
  for (const { connector, changes } of reportData) {
    if (changes.length === 0) continue;
    
    // Determine if connector has critical changes
    const hasCritical = changes.some(c => c.priority === 'P0');
    
    reportHTML += `
      <h2 id="connector-${connector}">üîå Connector: ${connector}</h2>
      <details ${hasCritical ? 'open' : ''}>
        <summary><strong>Changes (${changes.length})</strong></summary>
    `;
    
    // Generate change summary
    const summary = [];
    if (changes.some(c => c.type === 'file-added')) {
      summary.push('üÜï New files added');
    }
    if (changes.some(c => c.type === 'file-removed')) {
      summary.push('üóëÔ∏è Files removed');
    }
    if (changes.some(c => c.type === 'folder-added')) {
      summary.push('üìÅ New folders added');
    }
    if (changes.some(c => c.type === 'folder-removed')) {
      summary.push('üìÅ Folders removed');
    }
    if (changes.some(c => c.type === 'modified' && c.path && c.path.includes('auth'))) {
      summary.push('üîê Auth changes');
    }
    if (changes.some(c => c.type === 'modified' && c.path && c.path.includes('outputFields'))) {
      summary.push('üì¶ Output structure changes');
    }
    
    reportHTML += '<h3>üßæ Summary of Changes</h3><ul>';
    for (const item of summary) {
      reportHTML += `<li>${item}</li>`;
    }
    reportHTML += '</ul>';
    
    // Group changes by priority
    const changesByPriority = {
      P0: [],
      P1: [],
      P2: []
    };
    
    for (const change of changes) {
      changesByPriority[change.priority].push(change);
    }
    
    // Priority icons
    const priorityIcons = {
      P0: 'üî¥ Critical',
      P1: 'üü† Major',
      P2: 'üü¢ Minor'
    };
    
    // Show changes grouped by priority
    for (const priority of ['P0', 'P1', 'P2']) {
      const priorityChanges = changesByPriority[priority];
      if (priorityChanges.length === 0) continue;
      
      const openByDefault = priority === 'P0';
      
      reportHTML += `
        <h3>${priorityIcons[priority]} Changes (${priorityChanges.length})</h3>
        <details ${openByDefault ? 'open' : ''}>
          <summary><strong>${priority === 'P0' ? 'Critical' : priority === 'P1' ? 'Major' : 'Minor'} Changes</strong></summary>
      `;
      
      // Group by category
      const categorizedChanges = {};
      for (const change of priorityChanges) {
        const category = change.category || 'general';
        if (!categorizedChanges[category]) {
          categorizedChanges[category] = [];
        }
        categorizedChanges[category].push(change);
      }
      
      // Display changes by category
      for (const [category, categoryChanges] of Object.entries(categorizedChanges)) {
        const categoryTitle = category.charAt(0).toUpperCase() + category.slice(1);
        
        if (Object.keys(categorizedChanges).length > 1) {
          reportHTML += `<h4>üìÇ ${categoryTitle}</h4>`;
        }
        
        // Display each change
        for (const change of categoryChanges) {
          const emoji = getChangeEmoji(change.type, change.priority);
          const anchor = `${connector}-${change.category}-${change.type}-${change.path || change.file || change.folder}`.replace(/[^\w-]/g, '-');
          
          reportHTML += `<div id="${anchor}" data-priority="${change.priority}" data-type="${change.type}" data-category="${change.category}" class="change-item">`;
          
          if (change.type === 'file-added') {
            reportHTML += `<p>${emoji} <strong>New file:</strong> <code>${change.file}</code></p>`;
          } else if (change.type === 'file-removed') {
            reportHTML += `<p>${emoji} <strong>Removed file:</strong> <code>${change.file}</code></p>`;
          } else if (change.type === 'folder-added') {
            reportHTML += `<p>${emoji} <strong>New folder added:</strong> <code>${change.folder}/</code></p>`;
          } else if (change.type === 'folder-removed') {
            reportHTML += `<p>${emoji} <strong>Folder removed:</strong> <code>${change.folder}/</code></p>`;
          } else if (change.type === 'added') {
            reportHTML += `
              <p>${emoji} <strong>Added:</strong> <code>${change.path}</code></p>
              <pre><code class="change-added">${JSON.stringify(change.newVal, null, 2)}</code></pre>
            `;
          } else if (change.type === 'removed') {
            reportHTML += `
              <p>${emoji} <strong>Removed:</strong> <code>${change.path}</code></p>
              <pre><code class="change-removed">${JSON.stringify(change.oldVal, null, 2)}</code></pre>
            `;
          } else if (change.type === 'modified') {
            // Word-level diff highlighting for simple values
            const isSimpleValue = (
              (typeof change.oldVal !== 'object' || change.oldVal === null) &&
              (typeof change.newVal !== 'object' || change.newVal === null)
            );
            
            reportHTML += `<p>${emoji} <strong>Changed:</strong> <code>${change.path}</code></p>`;
            
            if (isSimpleValue) {
              // For simple values, show inline diff
              const oldStr = String(change.oldVal);
              const newStr = String(change.newVal);
              
              reportHTML += `
                <div class="inline-diff">
                  <p><strong>Before:</strong> <code class="change-removed">${oldStr}</code></p>
                  <p><strong>After:</strong> <code class="change-added">${newStr}</code></p>
                </div>
              `;
            } else {
              // For complex objects, show side-by-side comparison
              reportHTML += `
                <table>
                  <tr>
                    <th>Before</th>
                    <th>After</th>
                  </tr>
                  <tr>
                    <td><pre><code class="change-removed">${JSON.stringify(change.oldVal, null, 2)}</code></pre></td>
                    <td><pre><code class="change-added">${JSON.stringify(change.newVal, null, 2)}</code></pre></td>
                  </tr>
                </table>
              `;
            }
          }
          
          reportHTML += '</div>';
        }
      }
      
      reportHTML += '</details>';
    }
    
    reportHTML += `
      </details>
      <p><a href="#table-of-contents">Back to Table of Contents</a></p>
    `;
  }
  
  reportElement.innerHTML = reportHTML;
}

// Setup event listeners
function setupEventListeners() {
  // Priority filters
  document.getElementById('filter-p0').addEventListener('change', function() {
    filterState.priority.P0 = this.checked;
    applyFilters();
    updateUrlParams();
  });
  
  document.getElementById('filter-p1').addEventListener('change', function() {
    filterState.priority.P1 = this.checked;
    applyFilters();
    updateUrlParams();
  });
  
  document.getElementById('filter-p2').addEventListener('change', function() {
    filterState.priority.P2 = this.checked;
    applyFilters();
    updateUrlParams();
  });
  
  // Type filters
  document.getElementById('filter-added').addEventListener('change', function() {
    filterState.type.added = this.checked;
    filterState.type['file-added'] = this.checked;
    filterState.type['folder-added'] = this.checked;
    applyFilters();
    updateUrlParams();
  });
  
  document.getElementById('filter-removed').addEventListener('change', function() {
    filterState.type.removed = this.checked;
    filterState.type['file-removed'] = this.checked;
    filterState.type['folder-removed'] = this.checked;
    applyFilters();
    updateUrlParams();
  });
  
  document.getElementById('filter-modified').addEventListener('change', function() {
    filterState.type.modified = this.checked;
    applyFilters();
    updateUrlParams();
  });
  
  // Category filters
  const categoryCheckboxes = document.querySelectorAll('#category-filters input[type="checkbox"]');
  categoryCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      filterState.category[this.dataset.category] = this.checked;
      applyFilters();
      updateUrlParams();
    });
  });
  
  // Search input
  const searchInput = document.getElementById('search-input');
  searchInput.addEventListener('input', function() {
    filterState.search = this.value.toLowerCase();
    applyFilters();
    updateUrlParams();
  });
  
  // Reset filters button
  document.getElementById('btn-reset-filters').addEventListener('click', function() {
    resetFilters();
  });
  
  // Export buttons
  document.getElementById('btn-export-pdf').addEventListener('click', function() {
    window.print();
  });
  
  document.getElementById('btn-export-html').addEventListener('click', function() {
    exportHTML();
  });
  
  document.getElementById('btn-export-md').addEventListener('click', function() {
    exportMarkdown();
  });
  
  document.getElementById('btn-export-json').addEventListener('click', function() {
    exportJSON();
  });
}

// Setup back to top button
function setupBackToTop() {
  const backToTopButton = document.getElementById('back-to-top');
  
  // Show button when page is scrolled down
  window.addEventListener('scroll', function() {
    if (window.pageYOffset > 300) {
      backToTopButton.classList.add('visible');
    } else {
      backToTopButton.classList.remove('visible');
    }
  });
  
  // Scroll to top when button is clicked
  backToTopButton.addEventListener('click', function() {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  });
}

// Export functions
function exportHTML() {
  // Create a standalone version of the current page
  const htmlContent = document.documentElement.outerHTML;
  
  // Create a blob and download link
  const blob = new Blob([htmlContent], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = 'functional-change-report.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function exportMarkdown() {
  // Use backend to generate markdown
  window.location.href = 'functional-change-report.md';
}

function exportJSON() {
  // Use backend to get JSON data
  window.location.href = 'functional-change-data.json';
}
